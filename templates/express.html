<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Job Portal Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/80 backdrop-blur">
            <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-cyan-400"></div>
                    <div>
                        <h1 class="text-lg font-semibold leading-tight">Job Portal Aggregator</h1>
                        <p class="text-xs text-slate-400">Fetch → parse JSON/HTML → filter → render</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button id="runBtn"
                        class="rounded-xl bg-indigo-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-400 active:scale-[0.99]">
                        Run
                    </button>
                    <button id="clearBtn"
                        class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 active:scale-[0.99]">
                        Clear
                    </button>
                </div>
            </div>
        </header>

        <main class="mx-auto max-w-6xl px-4 py-6">
            <!-- Notice -->
            <div class="mb-6 rounded-2xl border border-amber-400/20 bg-amber-500/10 p-4">
                <p class="text-sm text-amber-100">
                    <span class="font-semibold">Backend-powered:</span> All job fetching and parsing happens on the server.
                    The backend aggregates jobs from multiple portals and returns filtered results.
                </p>
                <p class="mt-2 text-xs text-amber-100/80">
                    No CORS issues! The Express server fetches all data server-side and sends it to the client.
                </p>
            </div>

            <!-- Controls -->
            <section class="mb-6 grid gap-4 md:grid-cols-2">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <h2 class="text-sm font-semibold">Exclude keywords</h2>
                    <p class="mt-1 text-xs text-slate-400">Case-insensitive "contains" filter on titles.</p>
                    <label class="mt-3 block text-xs text-slate-300">Keywords (one per line)</label>
                    <textarea id="excludeInput" rows="7"
                        class="mt-1 w-full resize-none rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500/60"></textarea>
                </div>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <h2 class="text-sm font-semibold">Status</h2>
                    <div class="mt-3 space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Portals</span>
                            <span id="portalCount" class="font-semibold">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Jobs (after filter)</span>
                            <span id="jobCount" class="font-semibold">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Errors</span>
                            <span id="errorCount" class="font-semibold">0</span>
                        </div>
                    </div>

                    <div class="mt-4 rounded-xl border border-white/10 bg-slate-900/40 p-3">
                        <p class="text-xs text-slate-400">
                            Tip: Check the Raw log below to see backend processing details.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Results -->
            <section class="space-y-4">
                <div class="flex items-end justify-between">
                    <h2 class="text-base font-semibold">Results</h2>
                    <div id="spinner" class="hidden items-center gap-2 text-xs text-slate-400">
                        <span
                            class="inline-block h-3 w-3 animate-spin rounded-full border-2 border-white/10 border-t-white/60"></span>
                        Running…
                    </div>
                </div>

                <div id="results" class="grid gap-4 lg:grid-cols-2"></div>

                <div class="mt-10 rounded-2xl border border-white/10 bg-white/5 p-4">
                    <h3 class="text-sm font-semibold">Raw log</h3>
                    <pre id="log"
                        class="mt-3 max-h-64 overflow-auto rounded-xl border border-white/10 bg-slate-950/40 p-3 text-xs text-slate-200"></pre>
                </div>
            </section>
        </main>
    </div>

    <script>
        // -----------------------------
        // UI helpers and backend communication
        // -----------------------------
        const $ = (id) => document.getElementById(id);

        const default_exclude_keywords = ["Senior ", "Lead ", "Security", "Experienced ", "Expert ", "Praktikum", "Intern"];

        function logLine(msg) {
            const el = $("log");
            el.textContent += msg + "\n";
            el.scrollTop = el.scrollHeight;
        }

        function setBusy(isBusy) {
            $("spinner").classList.toggle("hidden", !isBusy);
            $("spinner").classList.toggle("flex", isBusy);
            $("runBtn").disabled = isBusy;
            $("runBtn").classList.toggle("opacity-60", isBusy);
            $("runBtn").classList.toggle("cursor-not-allowed", isBusy);
        }

        function escapeHtml(s) {
            return String(s)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function getExcludeKeywords() {
            const raw = $("excludeInput").value
                .split("\n")
                .filter(Boolean);
            return raw.length ? raw : default_exclude_keywords;
        }

        // -----------------------------
        // Render
        // -----------------------------
        function renderPortalCard({ name, url, jobs, error }) {
            const container = $("results");

            const card = document.createElement("div");
            card.className =
                "rounded-2xl border border-white/10 bg-white/5 p-4 shadow-sm hover:bg-white/7 transition";

            const header = document.createElement("div");
            header.className = "flex items-start justify-between gap-3";

            header.innerHTML = `
          <div>
            <h3 class="text-sm font-semibold">${escapeHtml(name)}</h3>
            <p class="mt-1 text-xs text-slate-400 break-all line-clamp-1" title="${escapeHtml(url)}">${escapeHtml(url)}</p>
          </div>
          <span class="shrink-0 rounded-full border border-white/10 bg-slate-900/40 px-2 py-1 text-xs text-slate-300">
            ${error ? "Error" : `${jobs.length} jobs`}
          </span>
        `;
            card.appendChild(header);

            if (error) {
                const err = document.createElement("div");
                err.className =
                    "mt-3 rounded-xl border border-rose-400/20 bg-rose-500/10 p-3 text-xs text-rose-200";
                err.textContent = error;
                card.appendChild(err);
            } else if (jobs.length === 0) {
                const empty = document.createElement("div");
                empty.className =
                    "mt-3 rounded-xl border border-white/10 bg-slate-900/30 p-3 text-xs text-slate-300";
                empty.textContent = "No job postings found after applying filters (or parser didn't match HTML).";
                card.appendChild(empty);
            } else {
                const list = document.createElement("div");
                list.className = "mt-3 space-y-2";

                for (const j of jobs) {
                    const item = document.createElement("a");
                    item.className =
                        "block rounded-xl border border-white/10 bg-slate-900/30 p-3 hover:bg-slate-900/50 transition";
                    item.target = "_blank";
                    item.rel = "noreferrer";
                    item.href = j.link && j.link !== "N/A" ? j.link : url;

                    item.innerHTML = `
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold leading-snug">${escapeHtml(j.title)}</div>
                  <div class="mt-1 text-xs text-slate-400">${escapeHtml(j.location || "N/A")}</div>
                </div>
                <div class="text-xs text-slate-400">↗</div>
              </div>
            `;
                    list.appendChild(item);
                }

                card.appendChild(list);
            }

            container.appendChild(card);
        }

        function clearUI() {
            $("results").innerHTML = "";
            $("log").textContent = "";
            $("portalCount").textContent = "0";
            $("jobCount").textContent = "0";
            $("errorCount").textContent = "0";
        }

        // -----------------------------
        // Fetch jobs from backend
        // -----------------------------
        async function run() {
            clearUI();
            setBusy(true);

            const excludeKeywords = getExcludeKeywords();
            logLine("Fetching jobs from backend...");
            logLine("Exclude keywords:");
            excludeKeywords.forEach((k) => logLine(`- ${k}`));

            try {
                // Call backend API with exclude keywords as query parameter
                const excludeParam = excludeKeywords.join(',');
                const apiUrl = `/api/jobs?exclude=${encodeURIComponent(excludeParam)}`;
                
                logLine(`\nGET ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                logLine(`\nReceived data from backend:`);
                logLine(`- Portals: ${data.summary.totalPortals}`);
                logLine(`- Total jobs: ${data.summary.totalJobs}`);
                logLine(`- Errors: ${data.summary.errorCount}`);
                
                // Update status
                $("portalCount").textContent = String(data.summary.totalPortals);
                $("jobCount").textContent = String(data.summary.totalJobs);
                $("errorCount").textContent = String(data.summary.errorCount);
                
                // Render results for each portal
                for (const portal of data.portals) {
                    logLine(`\n=== ${portal.name} ===`);
                    if (portal.error) {
                        logLine(`ERROR: ${portal.error}`);
                    } else {
                        logLine(`Jobs found: ${portal.jobs.length}`);
                        for (const job of portal.jobs) {
                            logLine(`  ${job.title} (${job.location}) - ${job.link}`);
                        }
                    }
                    renderPortalCard(portal);
                }
                
            } catch (error) {
                logLine(`\nERROR: ${error.message}`);
                $("errorCount").textContent = "1";
            }

            setBusy(false);
        }

        // -----------------------------
        // Init
        // -----------------------------
        $("excludeInput").value = default_exclude_keywords.join("\n");
        
        $("runBtn").addEventListener("click", run);
        $("clearBtn").addEventListener("click", clearUI);
    </script>
</body>

</html>
