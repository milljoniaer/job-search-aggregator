<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Job Portal Aggregator (Static)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/80 backdrop-blur">
            <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-cyan-400"></div>
                    <div>
                        <h1 class="text-lg font-semibold leading-tight">Job Portal Aggregator</h1>
                        <p class="text-xs text-slate-400">Pre-fetched data with client-side filtering</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button id="filterBtn"
                        class="rounded-xl bg-indigo-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-400 active:scale-[0.99]">
                        Apply Filters
                    </button>
                    <button id="clearBtn"
                        class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 active:scale-[0.99]">
                        Clear Filters
                    </button>
                </div>
            </div>
        </header>

        <main class="mx-auto max-w-6xl px-4 py-6">
            <!-- Notice -->
            <div class="mb-6 rounded-2xl border border-blue-400/20 bg-blue-500/10 p-4">
                <p class="text-sm text-blue-100">
                    <span class="font-semibold">Static Data:</span> Job listings are fetched daily at 7 AM UTC and pre-loaded into this page.
                    Filtering happens entirely in your browser.
                </p>
                <p class="mt-2 text-xs text-blue-100/80">
                    Last updated: {{LAST_UPDATED}} • Total jobs: {{TOTAL_JOBS}}
                </p>
            </div>

            <!-- Controls -->
            <section class="mb-6 grid gap-4 md:grid-cols-2">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <h2 class="text-sm font-semibold">Exclude keywords</h2>
                    <p class="mt-1 text-xs text-slate-400">Case-insensitive "contains" filter on titles.</p>
                    <label class="mt-3 block text-xs text-slate-300">Keywords (one per line)</label>
                    <textarea id="excludeInput" rows="7"
                        class="mt-1 w-full resize-none rounded-xl border border-white/10 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500/60"></textarea>
                </div>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <h2 class="text-sm font-semibold">Status</h2>
                    <div class="mt-3 space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Portals</span>
                            <span id="portalCount" class="font-semibold">{{PORTAL_COUNT}}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Jobs (after filter)</span>
                            <span id="jobCount" class="font-semibold">{{TOTAL_JOBS}}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-400">Errors</span>
                            <span id="errorCount" class="font-semibold">{{ERROR_COUNT}}</span>
                        </div>
                    </div>

                    <div class="mt-4 rounded-xl border border-white/10 bg-slate-900/40 p-3">
                        <p class="text-xs text-slate-400">
                            Data is pre-fetched. Filtering happens instantly in your browser.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Results -->
            <section class="space-y-4">
                <div class="flex items-end justify-between">
                    <h2 class="text-base font-semibold">Results</h2>
                </div>

                <div id="results" class="grid gap-4 lg:grid-cols-2"></div>
            </section>
        </main>
    </div>

    <script>
        // Pre-loaded job data
        const jobsData = {{JOBS_DATA}};
        
        const default_exclude_keywords = {{DEFAULT_EXCLUDE_KEYWORDS}};

        const $ = (id) => document.getElementById(id);

        function escapeHtml(s) {
            return String(s)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function getExcludeKeywords() {
            const raw = $("excludeInput").value
                .split("\n")
                .filter(Boolean);
            return raw.length ? raw : default_exclude_keywords;
        }

        function passesFilter(title, excludeKeywords) {
            const t = (title || "").toLowerCase();
            return !excludeKeywords.some((kw) => t.includes(kw.toLowerCase()));
        }

        function renderPortalCard({ name, url, jobs, error }) {
            const container = $("results");

            const card = document.createElement("div");
            card.className =
                "rounded-2xl border border-white/10 bg-white/5 p-4 shadow-sm hover:bg-white/7 transition";

            const header = document.createElement("div");
            header.className = "flex items-start justify-between gap-3";

            header.innerHTML = `
              <div>
                <h3 class="text-sm font-semibold">${escapeHtml(name)}</h3>
                <p class="mt-1 text-xs text-slate-400 break-all line-clamp-1" title="${escapeHtml(url)}">${escapeHtml(url)}</p>
              </div>
              <span class="shrink-0 rounded-full border border-white/10 bg-slate-900/40 px-2 py-1 text-xs text-slate-300">
                ${error ? "Error" : `${jobs.length} jobs`}
              </span>
            `;
            card.appendChild(header);

            if (error) {
                const err = document.createElement("div");
                err.className =
                    "mt-3 rounded-xl border border-rose-400/20 bg-rose-500/10 p-3 text-xs text-rose-200";
                err.textContent = error;
                card.appendChild(err);
            } else if (jobs.length === 0) {
                const empty = document.createElement("div");
                empty.className =
                    "mt-3 rounded-xl border border-white/10 bg-slate-900/30 p-3 text-xs text-slate-300";
                empty.textContent = "No job postings found after applying filters.";
                card.appendChild(empty);
            } else {
                const list = document.createElement("div");
                list.className = "mt-3 space-y-2";

                for (const j of jobs) {
                    const item = document.createElement("a");
                    item.className =
                        "block rounded-xl border border-white/10 bg-slate-900/30 p-3 hover:bg-slate-900/50 transition";
                    item.target = "_blank";
                    item.rel = "noreferrer";
                    item.href = j.link && j.link !== "N/A" ? j.link : url;

                    item.innerHTML = `
                      <div class="flex items-start justify-between gap-3">
                        <div>
                          <div class="text-sm font-semibold leading-snug">${escapeHtml(j.title)}</div>
                          <div class="mt-1 text-xs text-slate-400">${escapeHtml(j.location || "N/A")}</div>
                        </div>
                        <div class="text-xs text-slate-400">↗</div>
                      </div>
                    `;
                    list.appendChild(item);
                }

                card.appendChild(list);
            }

            container.appendChild(card);
        }

        function clearUI() {
            $("results").innerHTML = "";
        }

        function applyFilters() {
            clearUI();
            
            const excludeKeywords = getExcludeKeywords();
            
            let totalJobs = 0;
            
            for (const portal of jobsData) {
                if (portal.error) {
                    renderPortalCard(portal);
                    continue;
                }
                
                const jobsFiltered = portal.jobs.filter((j) => passesFilter(j.title, excludeKeywords));
                totalJobs += jobsFiltered.length;
                
                renderPortalCard({
                    name: portal.name,
                    url: portal.url,
                    jobs: jobsFiltered,
                    error: portal.error
                });
            }
            
            $("jobCount").textContent = String(totalJobs);
        }

        function clearFilters() {
            $("excludeInput").value = default_exclude_keywords.join("\n");
            applyFilters();
        }

        // Initialize
        $("excludeInput").value = default_exclude_keywords.join("\n");
        $("filterBtn").addEventListener("click", applyFilters);
        $("clearBtn").addEventListener("click", clearFilters);
        
        // Apply filters on load
        applyFilters();
    </script>
</body>

</html>
